
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Unlock the potential of eBPF">
      
      
      
        <link rel="canonical" href="https://eunomia.dev/tutorials/45-scx-nest/">
      
      
        <link rel="prev" href="../44-scx-simple/">
      
      
        <link rel="next" href="../46-xdp-test/">
      
      
      <link rel="icon" href="../../assets/icon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.4">
    
    
      
        <title>eBPF Tutorial by Example: Implementing the scx_nest Scheduler - eunomia</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-1YVMXGL0MY"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-1YVMXGL0MY",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-1YVMXGL0MY",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="eBPF Tutorial by Example: Implementing the scx_nest Scheduler - eunomia" >
      
        <meta  property="og:description"  content="Unlock the potential of eBPF" >
      
        <meta  property="og:image"  content="https://eunomia.dev/assets/images/social/tutorials/45-scx-nest/README.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://eunomia.dev/tutorials/45-scx-nest/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="eBPF Tutorial by Example: Implementing the scx_nest Scheduler - eunomia" >
      
        <meta  name="twitter:description"  content="Unlock the potential of eBPF" >
      
        <meta  name="twitter:image"  content="https://eunomia.dev/assets/images/social/tutorials/45-scx-nest/README.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ebpf-tutorial-by-example-implementing-the-scx_nest-scheduler" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="eunomia" class="md-header__button md-logo" aria-label="eunomia" data-md-component="logo">
      
  <img src="../../assets/icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            eunomia
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              eBPF Tutorial by Example: Implementing the scx_nest Scheduler
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/zh/" hreflang="zh" class="md-select__link">
              Chinese
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/eunomia-bpf/eunomia.dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  Home

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../blog" class="md-tabs__link">
        
  
    
  
  Blog

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bpftime/" class="md-tabs__link">
          
  
  bpftime

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../eunomia-bpf/" class="md-tabs__link">
          
  
  eunomia-bpf

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../GPTtrace/" class="md-tabs__link">
          
  
  GPTtrace

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wasm-bpf/" class="md-tabs__link">
          
  
  wasm-bpf

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../others/" class="md-tabs__link">
          
  
  Ecosystem

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="eunomia" class="md-nav__button md-logo" aria-label="eunomia" data-md-component="logo">
      
  <img src="../../assets/icon.svg" alt="logo">

    </a>
    eunomia
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/eunomia-bpf/eunomia.dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Eunomia - Unlock the potential of eBPF
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example: Learning CO-RE eBPF Step by Step
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../SUMMARY/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example: Learning CO-RE eBPF Step by Step
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../0-introduce/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 0: Introduction to Core Concepts and Tools
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1-helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 1: Hello World, Framework and Development
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10-hardirqs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 10: Capturing Interrupts with hardirqs or softirqs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11-bootstrap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 11: Develop User-Space Programs with libbpf and Trace exec() and exit()
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12-profile/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 12: Using eBPF Program Profile for Performance Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13-tcpconnlat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 13: Statistics of TCP Connection Delay with libbpf
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14-tcpstates/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 14: Recording TCP Connection Status and TCP RTT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../15-javagc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 15: Capturing User-Space Java GC Duration Using USDT
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../16-memleak/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 16: Monitoring Memory Leaks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../17-biopattern/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 17: Count Random/Sequential Disk I/O
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../18-further-reading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    More Reference Materials： papers, projects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../18-further-reading/ebpf-security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The Secure Path Forward for eBPF runtime: Challenges and Innovations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../19-lsm-connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 19: Security Detection and Defense using LSM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2-kprobe-unlink/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 2: Monitoring unlink System Calls with kprobe
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../20-tc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 20: tc Traffic Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../21-xdp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 21: Programmable Packet Processing with XDP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../22-android/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example: Using eBPF Programs on Android
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../23-http/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L7 Tracing with eBPF: HTTP and Beyond via Socket Filters and Syscall Tracepoints
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../24-hide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Practical Tutorial: Hiding Process or File Information
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../25-signal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using bpf_send_signal to Terminate Malicious Processes in eBPF
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../26-sudo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using eBPF to add sudo user
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../27-replace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Replace Text Read or Written by Any Program with eBPF
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../28-detach/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running eBPF After Application Exits: The Lifecycle of eBPF Programs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../29-sockops/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Development Practices: Accelerating Network Request Forwarding with Sockops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3-fentry-unlink/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 3: Monitoring unlink System Calls with fentry
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../30-sslsniff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Practical Tutorial: Capturing SSL/TLS Plain Text Data Using uprobe
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../31-goroutine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Practical Tutorial: Using eBPF to Trace Go Routine States
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../32-http2/README.zh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    trace http2 request in go
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../33-funclatency/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Measuring Function Latency with eBPF
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../34-syscall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Development Practice: Modifying System Call Arguments with eBPF
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../35-user-ringbuf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Development Practices: Asynchronously Send to Kernel with User Ring Buffer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../36-userspace-ebpf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Userspace eBPF Runtimes: Overview and Applications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../37-uprobe-rust/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Practice: Tracing User Space Rust Applications with Uprobe
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../38-btf-uprobe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Expanding eBPF Compile Once, Run Everywhere(CO-RE) to Userspace Compatibility
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../38-btf-uprobe/test-verify/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    using BTF to verify userspace eBPF extensions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../38-btf-uprobe/test-verify/minimal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    minimal examples
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../38-btf-uprobe/test-verify/module/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    write a basic kernel module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../39-nginx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using eBPF to Trace Nginx Requests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4-opensnoop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 4: Capturing Opening Files and Filter with Global Variables
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../40-mysql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using eBPF to Trace MySQL Queries
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../41-xdp-tcpdump/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example: Capturing TCP Information with XDP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../42-xdp-loadbalancer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Developer Tutorial: XDP Load Balancer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../42-xdp-loadbalancer/connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network setup for bpf-developer-tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../43-kfuncs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extending eBPF Beyond Its Limits: Custom kfuncs in Kernel Modules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../43-kfuncs/module/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    write a basic kernel module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../44-scx-simple/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial: Introduction to the BPF Scheduler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example: Implementing the scx_nest Scheduler
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example: Implementing the scx_nest Scheduler
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction-to-sched_ext" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction to sched_ext
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-the-scx_nest-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the scx_nest Scheduler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding the scx_nest Scheduler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-level-code-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Code Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="High-Level Code Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-data-structures-and-maps" class="md-nav__link">
    <span class="md-ellipsis">
      Core Data Structures and Maps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Data Structures and Maps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-context-task_ctx" class="md-nav__link">
    <span class="md-ellipsis">
      Task Context (task_ctx)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-cpu-context-pcpu_ctx" class="md-nav__link">
    <span class="md-ellipsis">
      Per-CPU Context (pcpu_ctx)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maps" class="md-nav__link">
    <span class="md-ellipsis">
      Maps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Core Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stat_inc" class="md-nav__link">
    <span class="md-ellipsis">
      stat_inc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vtime_before" class="md-nav__link">
    <span class="md-ellipsis">
      vtime_before
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#try_make_core_reserved" class="md-nav__link">
    <span class="md-ellipsis">
      try_make_core_reserved
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_attached" class="md-nav__link">
    <span class="md-ellipsis">
      update_attached
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compact_primary_core" class="md-nav__link">
    <span class="md-ellipsis">
      compact_primary_core
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_select_cpu" class="md-nav__link">
    <span class="md-ellipsis">
      nest_select_cpu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_enqueue" class="md-nav__link">
    <span class="md-ellipsis">
      nest_enqueue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_dispatch" class="md-nav__link">
    <span class="md-ellipsis">
      nest_dispatch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_running" class="md-nav__link">
    <span class="md-ellipsis">
      nest_running
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_stopping" class="md-nav__link">
    <span class="md-ellipsis">
      nest_stopping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_init_task" class="md-nav__link">
    <span class="md-ellipsis">
      nest_init_task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_enable" class="md-nav__link">
    <span class="md-ellipsis">
      nest_enable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stats_timerfn" class="md-nav__link">
    <span class="md-ellipsis">
      stats_timerfn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_init" class="md-nav__link">
    <span class="md-ellipsis">
      nest_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_exit" class="md-nav__link">
    <span class="md-ellipsis">
      nest_exit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scx_ops_define" class="md-nav__link">
    <span class="md-ellipsis">
      SCX_OPS_DEFINE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialization-and-cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      Initialization and Cleanup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initialization and Cleanup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nest_init-function" class="md-nav__link">
    <span class="md-ellipsis">
      nest_init Function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_exit-function" class="md-nav__link">
    <span class="md-ellipsis">
      nest_exit Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-scheduler-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Final Scheduler Definition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilation-and-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Compilation and Execution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compilation and Execution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sample-output" class="md-nav__link">
    <span class="md-ellipsis">
      Sample Output
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-and-call-to-action" class="md-nav__link">
    <span class="md-ellipsis">
      Summary and Call to Action
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../46-xdp-test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    xdp-pktgen: xdp based packet generator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5-uprobe-bashreadline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 5: Capturing readline Function Calls with Uprobe
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6-sigsnoop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 6: Capturing Signal Sending and Store State with Hash Maps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7-execsnoop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 7: Capturing Process Execution, Output with perf event array
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../8-exitsnoop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 8: Monitoring Process Exit Events, Output with Ring Buffer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../9-runqlat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Tutorial by Example 9: Capturing Scheduling Latency and Recording as Histogram
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/kernel-versions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux 内核版本的 BPF 功能
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/kernel-versions_en/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BPF Features by Linux Kernel Version
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/kernel_config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BPF 特性的内核配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/kernel_config_en/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kernel Configuration for BPF Features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/reference_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bcc 参考指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/reference_guide_en/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bcc Reference Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/special_filtering/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    特殊过滤
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/special_filtering_en/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Special Filtering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bcc 教程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/tutorial_bcc_python_developer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bcc Python 开发者教程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/tutorial_bcc_python_developer_en/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bcc Python Developer Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcc-documents/tutorial_en/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bcc Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bpftrace-tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The bpftrace One-Liner Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scripts/guideline_advance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog Guidelines for Advanced eBPF Tutorials
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scripts/guideline_basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    blog guideline or pattern
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../blog" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    bpftime
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            bpftime
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bpftime: Userspace eBPF runtime for Observability, Network &amp; General extensions Framework
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/build-and-test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building and Test
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Manual
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Examples &amp; Use Cases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/available-features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Available kernel features in userspace
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6" >
        
          
          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bpftime
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            Bpftime
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/llvmbpf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Userspace eBPF VM with LLVM JIT/AOT Compiler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6_2" >
        
          
          <label class="md-nav__link" for="__nav_4_6_2" id="__nav_4_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    EIM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6_2">
            <span class="md-nav__icon md-icon"></span>
            EIM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EIM: Extension Interface Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EIM: Example code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EIM: Extension Interface Model Specification
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/uprobe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UProbe Role Definition README
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EIM Usage and people involved (Draft v1)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6_2_6" >
        
          
          <label class="md-nav__link" for="__nav_4_6_2_6" id="__nav_4_6_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Draft spec
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_6_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6_2_6">
            <span class="md-nav__icon md-icon"></span>
            Draft spec
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/draft-spec/spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extension Inferface Model Specification V3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/draft-spec/spec_core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spec core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/draft-spec/spec_old/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extension Model Specification V1
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6_2_7" >
        
          
          <label class="md-nav__link" for="__nav_4_6_2_7" id="__nav_4_6_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Study
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_4_6_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6_2_7">
            <span class="md-nav__icon md-icon"></span>
            Study
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/study/browser-ide-bug-study/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Study on Bugs in Browser Extensions and IDE Plugins
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/study/compare/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extension Systems compare with EIM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/study/db-bug-study/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Study on Bugs in Database and Web Server Extension Interfaces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/EIM/study/docker-vm-bug-study/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Study on Hypervisor and Container Extension Bugs (2018–2024)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6_3" >
        
          
          <label class="md-nav__link" for="__nav_4_6_3" id="__nav_4_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Documents
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6_3">
            <span class="md-nav__icon md-icon"></span>
            Documents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/attach/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Detailed Implementation of the Attach Part
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/bpftimeaot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bpftime-aot cli
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/bpftimetool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bpftimetool
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/co-re/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compile Once, Run Everywhere(CO-RE)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/contact/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contact and citations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/how-it-works/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The design and implementation of bpftime
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bpftime/documents/performance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    performance and benchmark
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    eunomia-bpf
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            eunomia-bpf
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eunomia-bpf: simplify and enhance eBPF with CO-RE and WebAssembly
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Eunomia bpf
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Eunomia bpf
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/benchmark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    benchmark
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/manual/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    manual
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/online/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Online Demo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    quickstart
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/supporting-external-BTF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    supporting-external-BTF
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/video/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    video
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_8" >
        
          
          <label class="md-nav__link" for="__nav_5_2_8" id="__nav_5_2_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_8">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project architecture
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_9" >
        
          
          <label class="md-nav__link" for="__nav_5_2_9" id="__nav_5_2_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Ecc
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_9">
            <span class="md-nav__icon md-icon"></span>
            Ecc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/ecc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eunomia-cc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/ecc/docker-usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ecc docker usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/ecc/github-template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    github template
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/ecc/usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ecc usage
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_10" >
        
          
          <label class="md-nav__link" for="__nav_5_2_10" id="__nav_5_2_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Ecli
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_10">
            <span class="md-nav__icon md-icon"></span>
            Ecli
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/ecli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ecli
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/ecli/ecli-dockerfile-usage.zh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ecli dockerfile usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/ecli/server/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ecli server
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_11" >
        
          
          <label class="md-nav__link" for="__nav_5_2_11" id="__nav_5_2_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Exporter
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_11">
            <span class="md-nav__icon md-icon"></span>
            Exporter
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/exporter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exporter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/exporter/usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    usage
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2_12" >
        
          
          <label class="md-nav__link" for="__nav_5_2_12" id="__nav_5_2_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2_12">
            <span class="md-nav__icon md-icon"></span>
            Setup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/setup/build-android-arm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    build on android aarch64
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../eunomia-bpf/setup/build/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    build from source
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    GPTtrace
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            GPTtrace
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../GPTtrace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPTtrace 🤖
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    wasm-bpf
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            wasm-bpf
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wasm-bpf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wasm-bpf
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Ecosystem
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Ecosystem
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Other projects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8_2" >
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Others
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            Others
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/bpf-benchmark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BPF-Benchmark
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/bpf-compatible/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bpf-compatible
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/contribute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing to eunomia-bpf
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/ebpf-gpts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    An experiment: GPTs for eBPF
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/ideas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Possible ideas for the future
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/usecases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ebpf usecases analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8_2_7" >
        
          
          <label class="md-nav__link" for="__nav_8_2_7" id="__nav_8_2_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Miscellaneous
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_7">
            <span class="md-nav__icon md-icon"></span>
            Miscellaneous
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/bpftime-roadmap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About bpftime - bpftime ideas
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/ebpf-fuse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基于内核态/用户态 eBPF 实现高性能用户态文件系统功能 - 操作系统大赛赛题
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/ebpf-gpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用 eBPF 对 AI/ML 工作负载进行追踪和性能分析 - 操作系统大赛赛题
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/ebpf-linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project Proposal for bpftime - eBPF Foundation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/ebpf-lsm-usm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    实现内核与用户态共同工作的 eBPF 安全框架 - 操作系统大赛赛题
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/ebpf-usecases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Categorization of eBPF Hooks and Use Cases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/ebpf-userspace-port/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    将用户态 eBPF 扩展到 MacOS、Windows、FreeBSD 等更多平台 - 操作系统大赛赛题
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/gsoc-ospp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GSOC - OSPP draft proposal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/ideas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开源活动的可能想法 - eunomia-bpf 2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/linux-plumbers-talk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bpftime talk at linux plumbers 2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/roadmap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bpftime roadmap and ideas for 2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/talk-ebpf-summit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eBPF Summit 2025 bpftime talk
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/wasm-bpf-kubecon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Securing and Simplifying eBPF Deployments with WebAssembly
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../others/miscellaneous/wasm-bpf-talk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    talk draft in kubecon
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction-to-sched_ext" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction to sched_ext
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-the-scx_nest-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the scx_nest Scheduler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding the scx_nest Scheduler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-level-code-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Code Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="High-Level Code Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-data-structures-and-maps" class="md-nav__link">
    <span class="md-ellipsis">
      Core Data Structures and Maps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Data Structures and Maps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#task-context-task_ctx" class="md-nav__link">
    <span class="md-ellipsis">
      Task Context (task_ctx)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-cpu-context-pcpu_ctx" class="md-nav__link">
    <span class="md-ellipsis">
      Per-CPU Context (pcpu_ctx)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maps" class="md-nav__link">
    <span class="md-ellipsis">
      Maps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Core Functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stat_inc" class="md-nav__link">
    <span class="md-ellipsis">
      stat_inc
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vtime_before" class="md-nav__link">
    <span class="md-ellipsis">
      vtime_before
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#try_make_core_reserved" class="md-nav__link">
    <span class="md-ellipsis">
      try_make_core_reserved
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_attached" class="md-nav__link">
    <span class="md-ellipsis">
      update_attached
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compact_primary_core" class="md-nav__link">
    <span class="md-ellipsis">
      compact_primary_core
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_select_cpu" class="md-nav__link">
    <span class="md-ellipsis">
      nest_select_cpu
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_enqueue" class="md-nav__link">
    <span class="md-ellipsis">
      nest_enqueue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_dispatch" class="md-nav__link">
    <span class="md-ellipsis">
      nest_dispatch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_running" class="md-nav__link">
    <span class="md-ellipsis">
      nest_running
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_stopping" class="md-nav__link">
    <span class="md-ellipsis">
      nest_stopping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_init_task" class="md-nav__link">
    <span class="md-ellipsis">
      nest_init_task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_enable" class="md-nav__link">
    <span class="md-ellipsis">
      nest_enable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stats_timerfn" class="md-nav__link">
    <span class="md-ellipsis">
      stats_timerfn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_init" class="md-nav__link">
    <span class="md-ellipsis">
      nest_init
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_exit" class="md-nav__link">
    <span class="md-ellipsis">
      nest_exit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scx_ops_define" class="md-nav__link">
    <span class="md-ellipsis">
      SCX_OPS_DEFINE
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialization-and-cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      Initialization and Cleanup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initialization and Cleanup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nest_init-function" class="md-nav__link">
    <span class="md-ellipsis">
      nest_init Function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nest_exit-function" class="md-nav__link">
    <span class="md-ellipsis">
      nest_exit Function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-scheduler-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Final Scheduler Definition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compilation-and-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Compilation and Execution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compilation and Execution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sample-output" class="md-nav__link">
    <span class="md-ellipsis">
      Sample Output
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-and-call-to-action" class="md-nav__link">
    <span class="md-ellipsis">
      Summary and Call to Action
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/eunomia-bpf/eunomia.dev/tree/main/docs/tutorials/45-scx-nest/README.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/eunomia-bpf/eunomia.dev/tree/main/docs/tutorials/45-scx-nest/README.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="ebpf-tutorial-by-example-implementing-the-scx_nest-scheduler">eBPF Tutorial by Example: Implementing the <code>scx_nest</code> Scheduler</h1>
<p>In the ever-evolving landscape of system performance optimization, the ability to customize and extend kernel behavior is invaluable. One of the most powerful tools for achieving this is eBPF (extended Berkeley Packet Filter). In this tutorial, we'll explore the implementation of the <code>scx_nest</code> scheduler, an advanced eBPF program that leverages the <code>sched_ext</code> scheduler class introduced in Linux kernel version <code>6.12</code>. By the end of this guide, you'll understand how to build a sophisticated scheduler that dynamically adjusts task placement based on CPU core frequencies and utilization.</p>
<h2 id="introduction-to-sched_ext">Introduction to <code>sched_ext</code></h2>
<p>The <code>sched_ext</code> scheduler class marks a significant advancement in Linux kernel scheduling capabilities. Unlike traditional schedulers, <code>sched_ext</code> allows its behavior to be defined dynamically through a set of BPF (Berkeley Packet Filter) programs. This flexibility enables developers to implement custom scheduling algorithms tailored to specific workloads and system requirements.</p>
<h2 id="understanding-the-scx_nest-scheduler">Understanding the <code>scx_nest</code> Scheduler</h2>
<h3 id="overview">Overview</h3>
<p>The <code>scx_nest</code> scheduler is inspired by the Inria Paris paper titled "<a href="https://hal.inria.fr/hal-03612592/file/paper.pdf">OS Scheduling with Nest: Keeping Tasks Close Together on Warm Cores</a>." Developed by Meta Platforms, Inc., <code>scx_nest</code> focuses on encouraging task placement on CPU cores that are likely to run at higher frequencies based on recent usage patterns. This approach aims to optimize performance by ensuring that tasks execute on the most efficient cores available.</p>
<p>The scheduler operates as a global weighted virtual time (vtime) scheduler, similar to the Completely Fair Scheduler (CFS), while utilizing the Nest algorithm to select idle cores during task wakeup. This dual strategy ensures that tasks are not only fairly distributed but also placed on cores that can execute them most effectively.</p>
<p><code>scx_nest</code> is designed to optimize workloads with relatively low CPU utilization that can benefit from running on a subset of cores. By concentrating tasks on fewer cores, the scheduler helps maintain high frequencies on those cores, enhancing performance. However, for workloads that perform better when distributed across many cores to avoid cache thrashing, <code>scx_nest</code> may not be the ideal choice. Evaluating the suitability of <code>scx_nest</code> for a specific workload often requires experimentation.</p>
<p>Given its design, <code>scx_nest</code> is suitable for production environments, provided the hardware constraints are met. It performs optimally on single CCX (Core Complex) or single-socket hosts with a uniform L3 cache topology. While preemption is not implemented in the current version, the shared scheduling queue across all CPUs ensures that tasks at the front of the queue are executed promptly, provided there are enough CPUs available.</p>
<h2 id="high-level-code-analysis">High-Level Code Analysis</h2>
<p>The <code>scx_nest</code> scheduler's implementation is intricate, involving various data structures, maps, and functions that work in harmony to manage task placement and CPU core utilization. The complete source code is available in the <a href="https://github.com/eunomia-bpf/bpf-developer-tutorial">eunomia-bpf/bpf-developer-tutorial</a> repository. Below, we'll dissect the core components of the scheduler, explaining each part in detail.</p>
<h3 id="core-data-structures-and-maps">Core Data Structures and Maps</h3>
<h4 id="task-context-task_ctx">Task Context (<code>task_ctx</code>)</h4>
<p>Each task in the system has an associated context that maintains scheduling-related information. This context is crucial for making informed scheduling decisions based on the task's history and current state.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="cm">/* Per-task scheduling context */</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">task_ctx</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="cm">     * A temporary cpumask for calculating a task&#39;s primary and reserve</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="cm">     * mask.</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="cm">     */</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_cpumask</span><span class="w"> </span><span class="n">__kptr</span><span class="w"> </span><span class="o">*</span><span class="n">tmp_mask</span><span class="p">;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="cm">     * The number of times that a task observes that its previous core is</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="cm">     * not idle. If this occurs r_impatient times in a row, a core is</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="cm">     * attempted to be retrieved from either the reserve nest, or the</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="cm">     * fallback nest.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="cm">     */</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">prev_misses</span><span class="p">;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="cm">     * A core that the task is &quot;attached&quot; to, meaning the last core that it</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="cm">     * executed on at least twice in a row, and the core that it first</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="cm">     * tries to migrate to on wakeup. The task only migrates to the</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="cm">     * attached core if it is idle and in the primary nest.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="cm">     */</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">    </span><span class="n">s32</span><span class="w"> </span><span class="n">attached_core</span><span class="p">;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="cm">     * The last core that the task executed on. This is used to determine</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="cm">     * if the task should attach to the core that it will execute on next.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="cm">     */</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">    </span><span class="n">s32</span><span class="w"> </span><span class="n">prev_cpu</span><span class="p">;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="p">};</span>
</code></pre></div>
<p>The <code>task_ctx</code> structure holds a temporary CPU mask (<code>tmp_mask</code>) used for calculating the task's primary and reserve CPU sets. The <code>prev_misses</code> counter tracks how often the task's preferred core was not idle, influencing decisions to migrate the task to different cores. The <code>attached_core</code> indicates the core the task is currently bound to, ensuring it runs on a high-frequency core when possible. Lastly, <code>prev_cpu</code> records the last core the task executed on, aiding in maintaining task-core affinity.</p>
<h4 id="per-cpu-context-pcpu_ctx">Per-CPU Context (<code>pcpu_ctx</code>)</h4>
<p>Each CPU has an associated context that manages timers and compaction state. This context helps in determining when a core should be demoted from the primary nest due to inactivity.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">pcpu_ctx</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="cm">/* The timer used to compact the core from the primary nest. */</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="cm">/* Whether the current core has been scheduled for compaction. */</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">scheduled_compaction</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="p">};</span>
</code></pre></div>
<p>The <code>pcpu_ctx</code> structure contains a <code>bpf_timer</code> used to schedule compaction events and a boolean flag <code>scheduled_compaction</code> indicating whether a compaction has been scheduled for the core.</p>
<h4 id="maps">Maps</h4>
<p>Several BPF maps are utilized to store contexts and manage timers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="cm">/* Task storage map */</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_TASK_STORAGE</span><span class="p">);</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">map_flags</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_F_NO_PREALLOC</span><span class="p">);</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">);</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_ctx</span><span class="p">);</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="p">}</span><span class="w"> </span><span class="n">task_ctx_stor</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="cm">/* Per-CPU contexts */</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">);</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">s32</span><span class="p">);</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pcpu_ctx</span><span class="p">);</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="p">}</span><span class="w"> </span><span class="n">pcpu_ctxs</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="cm">/* Statistics timer */</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">);</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">    </span><span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="p">);</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">    </span><span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">stats_timer</span><span class="p">);</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="p">}</span><span class="w"> </span><span class="n">stats_timer</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>
</code></pre></div>
<ul>
<li><strong><code>task_ctx_stor</code>:</strong> This map stores the scheduling context for each task, enabling the scheduler to access and modify task-specific information.</li>
<li><strong><code>pcpu_ctxs</code>:</strong> An array map that holds the per-CPU contexts, allowing the scheduler to manage timers and compaction states for each CPU.</li>
<li><strong><code>stats_timer</code>:</strong> A single-entry array map used to manage a central timer for collecting scheduling statistics.</li>
</ul>
<p>Additionally, the scheduler maintains masks for primary, reserved, other, and idle CPUs, as well as a statistics map to track various scheduler metrics.</p>
<h3 id="core-functions">Core Functions</h3>
<h4 id="stat_inc"><code>stat_inc</code></h4>
<p>A helper function to increment scheduler statistics:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="o">*</span><span class="n">cnt_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cnt_p</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">cnt_p</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="p">}</span>
</code></pre></div>
<p>This function looks up a counter in the <code>stats</code> map and increments it if the counter exists. It's used throughout the scheduler to track various events and states.</p>
<h4 id="vtime_before"><code>vtime_before</code></h4>
<p>A utility function to compare virtual times:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">vtime_before</span><span class="p">(</span><span class="n">u64</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">s64</span><span class="p">)(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="p">}</span>
</code></pre></div>
<p>This function determines if virtual time <code>a</code> is before <code>b</code>, facilitating time-based scheduling decisions.</p>
<h4 id="try_make_core_reserved"><code>try_make_core_reserved</code></h4>
<p>Attempts to promote a core to the reserved nest:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">static</span><span class="w"> </span><span class="n">__always_inline</span><span class="w"> </span><span class="kt">void</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">try_make_core_reserved</span><span class="p">(</span><span class="n">s32</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_cpumask</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reserved</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">promotion</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="p">{</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="n">s32</span><span class="w"> </span><span class="n">tmp_nr_reserved</span><span class="p">;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="cm">     * This check is racy, but that&#39;s OK. If we incorrectly fail to promote</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="cm">     * a core to reserve, it&#39;s because another context added or removed a</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="cm">     * core from reserved in this small window. It will balance out over</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="cm">     * subsequent wakeups.</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="cm">     */</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">    </span><span class="n">tmp_nr_reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nr_reserved</span><span class="p">;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tmp_nr_reserved</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r_max</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">        </span><span class="cm">/*</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="cm">         * It&#39;s possible that we could exceed r_max for a time here,</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="cm">         * but that should balance out as more cores are either demoted</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="cm">         * or fail to be promoted into the reserve nest.</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="cm">         */</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">        </span><span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nr_reserved</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">        </span><span class="n">bpf_cpumask_set_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">reserved</span><span class="p">);</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">promotion</span><span class="p">)</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w">            </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">PROMOTED_TO_RESERVED</span><span class="p">));</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">            </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">DEMOTED_TO_RESERVED</span><span class="p">));</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="w">        </span><span class="n">bpf_cpumask_clear_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">reserved</span><span class="p">);</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w">        </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">RESERVED_AT_CAPACITY</span><span class="p">));</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>try_make_core_reserved</code> function attempts to add a CPU core to the reserved mask. It first checks if the number of reserved cores (<code>nr_reserved</code>) is below the maximum allowed (<code>r_max</code>). If so, it increments the <code>nr_reserved</code> counter and adds the core to the reserved mask. Depending on whether the core is being promoted or demoted, it increments the corresponding statistic. If the reserved capacity is full, it clears the core from the reserved mask and updates the relevant statistic.</p>
<h4 id="update_attached"><code>update_attached</code></h4>
<p>Updates the task's attached core based on recent execution:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">update_attached</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">tctx</span><span class="p">,</span><span class="w"> </span><span class="n">s32</span><span class="w"> </span><span class="n">prev_cpu</span><span class="p">,</span><span class="w"> </span><span class="n">s32</span><span class="w"> </span><span class="n">new_cpu</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">prev_cpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">new_cpu</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">        </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">attached_core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_cpu</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">prev_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev_cpu</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="p">}</span>
</code></pre></div>
<p>This function updates the <code>attached_core</code> for a task. If the task has executed on the same core consecutively, it attaches the task to that core. It then updates the <code>prev_cpu</code> to reflect the latest core the task ran on.</p>
<h4 id="compact_primary_core"><code>compact_primary_core</code></h4>
<p>Handles the compaction of a primary core by demoting it to the reserve nest:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">compact_primary_core</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_timer</span><span class="w"> </span><span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">primary</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">reserve</span><span class="p">;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="n">s32</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_get_smp_processor_id</span><span class="p">();</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pcpu_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">pcpu_ctx</span><span class="p">;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">CALLBACK_COMPACTED</span><span class="p">));</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="cm">     * If we made it to this callback, it means that the timer callback was</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="cm">     * never cancelled, and so the core needs to be demoted from the</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="cm">     * primary nest.</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="cm">     */</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="n">pcpu_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcpu_ctxs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpu</span><span class="p">);</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pcpu_ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t lookup pcpu ctx&quot;</span><span class="p">);</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="n">bpf_rcu_read_lock</span><span class="p">();</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="n">primary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primary_cpumask</span><span class="p">;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reserve_cpumask</span><span class="p">;</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">primary</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">reserve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find primary or reserve&quot;</span><span class="p">);</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">        </span><span class="n">bpf_rcu_read_unlock</span><span class="p">();</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">    </span><span class="n">bpf_cpumask_clear_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">primary</span><span class="p">);</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="n">try_make_core_reserved</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">reserve</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">    </span><span class="n">bpf_rcu_read_unlock</span><span class="p">();</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">    </span><span class="n">pcpu_ctx</span><span class="o">-&gt;</span><span class="n">scheduled_compaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="p">}</span>
</code></pre></div>
<p>When the compaction timer expires, <code>compact_primary_core</code> is invoked. It demotes the current CPU core from the primary nest to the reserve nest by clearing it from the primary mask and attempting to add it to the reserve mask using <code>try_make_core_reserved</code>. This ensures that inactive cores are efficiently managed, maintaining a balance between performance and resource utilization.</p>
<h4 id="nest_select_cpu"><code>nest_select_cpu</code></h4>
<p>Determines the appropriate CPU for a task upon waking up:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">s32</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_select_cpu</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">s32</span><span class="w"> </span><span class="n">prev_cpu</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">wake_flags</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">p_mask</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">primary</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">reserve</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="n">s32</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">tctx</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pcpu_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">pcpu_ctx</span><span class="p">;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">direct_to_primary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">reset_impatient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="n">tctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_task_storage_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_ctx_stor</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tctx</span><span class="p">)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">    </span><span class="n">bpf_rcu_read_lock</span><span class="p">();</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">    </span><span class="n">p_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">tmp_mask</span><span class="p">;</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">    </span><span class="n">primary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primary_cpumask</span><span class="p">;</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">    </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reserve_cpumask</span><span class="p">;</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">p_mask</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">primary</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">reserve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">        </span><span class="n">bpf_rcu_read_unlock</span><span class="p">();</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">    </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">prev_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev_cpu</span><span class="p">;</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">    </span><span class="n">bpf_cpumask_and</span><span class="p">(</span><span class="n">p_mask</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cpus_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">primary</span><span class="p">));</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">    </span><span class="cm">/* First try to wake the task on its attached core. */</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">attached_core</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">p_mask</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">        </span><span class="n">scx_bpf_test_and_clear_cpu_idle</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">attached_core</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">        </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">attached_core</span><span class="p">;</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="w">        </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">WAKEUP_ATTACHED</span><span class="p">));</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">migrate_primary</span><span class="p">;</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a><span class="cm">     * Try to stay on the previous core if it&#39;s in the primary set, and</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="cm">     * there&#39;s no hypertwin. If the previous core is the core the task is</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="cm">     * attached to, don&#39;t bother as we already just tried that above.</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="cm">     */</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prev_cpu</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">attached_core</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a><span class="w">        </span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">prev_cpu</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">p_mask</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="w">        </span><span class="n">scx_bpf_test_and_clear_cpu_idle</span><span class="p">(</span><span class="n">prev_cpu</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a><span class="w">        </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev_cpu</span><span class="p">;</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="w">        </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">WAKEUP_PREV_PRIMARY</span><span class="p">));</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">migrate_primary</span><span class="p">;</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">find_fully_idle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="w">        </span><span class="cm">/* Then try any fully idle core in primary. */</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a><span class="w">        </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scx_bpf_pick_idle_cpu</span><span class="p">(</span><span class="n">cast_mask</span><span class="p">(</span><span class="n">p_mask</span><span class="p">),</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="w">                                    </span><span class="n">SCX_PICK_IDLE_CORE</span><span class="p">);</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="w">            </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">WAKEUP_FULLY_IDLE_PRIMARY</span><span class="p">));</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">migrate_primary</span><span class="p">;</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a><span class="w">    </span><span class="cm">/* Then try _any_ idle core in primary, even if its hypertwin is active. */</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a><span class="w">    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scx_bpf_pick_idle_cpu</span><span class="p">(</span><span class="n">cast_mask</span><span class="p">(</span><span class="n">p_mask</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a><span class="w">        </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">WAKEUP_ANY_IDLE_PRIMARY</span><span class="p">));</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">migrate_primary</span><span class="p">;</span>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r_impatient</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">++</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">prev_misses</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">r_impatient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a><span class="w">        </span><span class="n">direct_to_primary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="w">        </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">prev_misses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a><span class="w">        </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">TASK_IMPATIENT</span><span class="p">));</span>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a><span class="w">    </span><span class="n">reset_impatient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a><span class="w">    </span><span class="cm">/* Then try any fully idle core in reserve. */</span>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a><span class="w">    </span><span class="n">bpf_cpumask_and</span><span class="p">(</span><span class="n">p_mask</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cpus_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">reserve</span><span class="p">));</span>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">find_fully_idle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a><span class="w">        </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scx_bpf_pick_idle_cpu</span><span class="p">(</span><span class="n">cast_mask</span><span class="p">(</span><span class="n">p_mask</span><span class="p">),</span>
<a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a><span class="w">                                    </span><span class="n">SCX_PICK_IDLE_CORE</span><span class="p">);</span>
<a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a><span class="w">            </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">WAKEUP_FULLY_IDLE_RESERVE</span><span class="p">));</span>
<a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">promote_to_primary</span><span class="p">;</span>
<a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-81" name="__codelineno-8-81" href="#__codelineno-8-81"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-82" name="__codelineno-8-82" href="#__codelineno-8-82"></a>
<a id="__codelineno-8-83" name="__codelineno-8-83" href="#__codelineno-8-83"></a><span class="w">    </span><span class="cm">/* Then try _any_ idle core in reserve, even if its hypertwin is active. */</span>
<a id="__codelineno-8-84" name="__codelineno-8-84" href="#__codelineno-8-84"></a><span class="w">    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scx_bpf_pick_idle_cpu</span><span class="p">(</span><span class="n">cast_mask</span><span class="p">(</span><span class="n">p_mask</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-8-85" name="__codelineno-8-85" href="#__codelineno-8-85"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-86" name="__codelineno-8-86" href="#__codelineno-8-86"></a><span class="w">        </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">WAKEUP_ANY_IDLE_RESERVE</span><span class="p">));</span>
<a id="__codelineno-8-87" name="__codelineno-8-87" href="#__codelineno-8-87"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">promote_to_primary</span><span class="p">;</span>
<a id="__codelineno-8-88" name="__codelineno-8-88" href="#__codelineno-8-88"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-89" name="__codelineno-8-89" href="#__codelineno-8-89"></a>
<a id="__codelineno-8-90" name="__codelineno-8-90" href="#__codelineno-8-90"></a><span class="w">    </span><span class="cm">/* Then try _any_ idle core in the task&#39;s cpumask. */</span>
<a id="__codelineno-8-91" name="__codelineno-8-91" href="#__codelineno-8-91"></a><span class="w">    </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scx_bpf_pick_idle_cpu</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cpus_ptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-8-92" name="__codelineno-8-92" href="#__codelineno-8-92"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-93" name="__codelineno-8-93" href="#__codelineno-8-93"></a><span class="w">        </span><span class="cm">/*</span>
<a id="__codelineno-8-94" name="__codelineno-8-94" href="#__codelineno-8-94"></a><span class="cm">         * We found a core that (we didn&#39;t _think_) is in any nest.</span>
<a id="__codelineno-8-95" name="__codelineno-8-95" href="#__codelineno-8-95"></a><span class="cm">         * This means that we need to either promote the core to the</span>
<a id="__codelineno-8-96" name="__codelineno-8-96" href="#__codelineno-8-96"></a><span class="cm">         * reserve nest, or if we&#39;re going direct to primary due to</span>
<a id="__codelineno-8-97" name="__codelineno-8-97" href="#__codelineno-8-97"></a><span class="cm">         * r_impatient being exceeded, promote directly to primary.</span>
<a id="__codelineno-8-98" name="__codelineno-8-98" href="#__codelineno-8-98"></a><span class="cm">         *</span>
<a id="__codelineno-8-99" name="__codelineno-8-99" href="#__codelineno-8-99"></a><span class="cm">         * We have to do one final check here to see if the core is in</span>
<a id="__codelineno-8-100" name="__codelineno-8-100" href="#__codelineno-8-100"></a><span class="cm">         * the primary or reserved cpumask because we could potentially</span>
<a id="__codelineno-8-101" name="__codelineno-8-101" href="#__codelineno-8-101"></a><span class="cm">         * race with the core changing states between AND&#39;ing the</span>
<a id="__codelineno-8-102" name="__codelineno-8-102" href="#__codelineno-8-102"></a><span class="cm">         * primary and reserve masks with p-&gt;cpus_ptr above, and</span>
<a id="__codelineno-8-103" name="__codelineno-8-103" href="#__codelineno-8-103"></a><span class="cm">         * atomically reserving it from the idle mask with</span>
<a id="__codelineno-8-104" name="__codelineno-8-104" href="#__codelineno-8-104"></a><span class="cm">         * scx_bpf_pick_idle_cpu(). This is also technically true of</span>
<a id="__codelineno-8-105" name="__codelineno-8-105" href="#__codelineno-8-105"></a><span class="cm">         * the checks above, but in all of those cases we just put the</span>
<a id="__codelineno-8-106" name="__codelineno-8-106" href="#__codelineno-8-106"></a><span class="cm">         * core directly into the primary mask so it&#39;s not really that</span>
<a id="__codelineno-8-107" name="__codelineno-8-107" href="#__codelineno-8-107"></a><span class="cm">         * big of a problem. Here, we want to make sure that we don&#39;t</span>
<a id="__codelineno-8-108" name="__codelineno-8-108" href="#__codelineno-8-108"></a><span class="cm">         * accidentally put a core into the reserve nest that was e.g.</span>
<a id="__codelineno-8-109" name="__codelineno-8-109" href="#__codelineno-8-109"></a><span class="cm">         * already in the primary nest. This is unlikely, but we check</span>
<a id="__codelineno-8-110" name="__codelineno-8-110" href="#__codelineno-8-110"></a><span class="cm">         * for it on what should be a relatively cold path regardless.</span>
<a id="__codelineno-8-111" name="__codelineno-8-111" href="#__codelineno-8-111"></a><span class="cm">         */</span>
<a id="__codelineno-8-112" name="__codelineno-8-112" href="#__codelineno-8-112"></a><span class="w">        </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">WAKEUP_IDLE_OTHER</span><span class="p">));</span>
<a id="__codelineno-8-113" name="__codelineno-8-113" href="#__codelineno-8-113"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">primary</span><span class="p">)))</span>
<a id="__codelineno-8-114" name="__codelineno-8-114" href="#__codelineno-8-114"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">migrate_primary</span><span class="p">;</span>
<a id="__codelineno-8-115" name="__codelineno-8-115" href="#__codelineno-8-115"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">reserve</span><span class="p">)))</span>
<a id="__codelineno-8-116" name="__codelineno-8-116" href="#__codelineno-8-116"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">promote_to_primary</span><span class="p">;</span>
<a id="__codelineno-8-117" name="__codelineno-8-117" href="#__codelineno-8-117"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">direct_to_primary</span><span class="p">)</span>
<a id="__codelineno-8-118" name="__codelineno-8-118" href="#__codelineno-8-118"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">promote_to_primary</span><span class="p">;</span>
<a id="__codelineno-8-119" name="__codelineno-8-119" href="#__codelineno-8-119"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-8-120" name="__codelineno-8-120" href="#__codelineno-8-120"></a><span class="w">            </span><span class="n">try_make_core_reserved</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">reserve</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<a id="__codelineno-8-121" name="__codelineno-8-121" href="#__codelineno-8-121"></a><span class="w">        </span><span class="n">bpf_rcu_read_unlock</span><span class="p">();</span>
<a id="__codelineno-8-122" name="__codelineno-8-122" href="#__codelineno-8-122"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<a id="__codelineno-8-123" name="__codelineno-8-123" href="#__codelineno-8-123"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-124" name="__codelineno-8-124" href="#__codelineno-8-124"></a>
<a id="__codelineno-8-125" name="__codelineno-8-125" href="#__codelineno-8-125"></a><span class="w">    </span><span class="n">bpf_rcu_read_unlock</span><span class="p">();</span>
<a id="__codelineno-8-126" name="__codelineno-8-126" href="#__codelineno-8-126"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">prev_cpu</span><span class="p">;</span>
<a id="__codelineno-8-127" name="__codelineno-8-127" href="#__codelineno-8-127"></a>
<a id="__codelineno-8-128" name="__codelineno-8-128" href="#__codelineno-8-128"></a><span class="nl">promote_to_primary</span><span class="p">:</span>
<a id="__codelineno-8-129" name="__codelineno-8-129" href="#__codelineno-8-129"></a><span class="w">    </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">PROMOTED_TO_PRIMARY</span><span class="p">));</span>
<a id="__codelineno-8-130" name="__codelineno-8-130" href="#__codelineno-8-130"></a><span class="nl">migrate_primary</span><span class="p">:</span>
<a id="__codelineno-8-131" name="__codelineno-8-131" href="#__codelineno-8-131"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reset_impatient</span><span class="p">)</span>
<a id="__codelineno-8-132" name="__codelineno-8-132" href="#__codelineno-8-132"></a><span class="w">        </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">prev_misses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-8-133" name="__codelineno-8-133" href="#__codelineno-8-133"></a><span class="w">    </span><span class="n">pcpu_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcpu_ctxs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpu</span><span class="p">);</span>
<a id="__codelineno-8-134" name="__codelineno-8-134" href="#__codelineno-8-134"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcpu_ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-135" name="__codelineno-8-135" href="#__codelineno-8-135"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pcpu_ctx</span><span class="o">-&gt;</span><span class="n">scheduled_compaction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-136" name="__codelineno-8-136" href="#__codelineno-8-136"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_timer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcpu_ctx</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-137" name="__codelineno-8-137" href="#__codelineno-8-137"></a><span class="w">                </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to cancel pcpu timer&quot;</span><span class="p">);</span>
<a id="__codelineno-8-138" name="__codelineno-8-138" href="#__codelineno-8-138"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_timer_set_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcpu_ctx</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">compact_primary_core</span><span class="p">))</span>
<a id="__codelineno-8-139" name="__codelineno-8-139" href="#__codelineno-8-139"></a><span class="w">                </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to re-arm pcpu timer&quot;</span><span class="p">);</span>
<a id="__codelineno-8-140" name="__codelineno-8-140" href="#__codelineno-8-140"></a><span class="w">            </span><span class="n">pcpu_ctx</span><span class="o">-&gt;</span><span class="n">scheduled_compaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-8-141" name="__codelineno-8-141" href="#__codelineno-8-141"></a><span class="w">            </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">CANCELLED_COMPACTION</span><span class="p">));</span>
<a id="__codelineno-8-142" name="__codelineno-8-142" href="#__codelineno-8-142"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-143" name="__codelineno-8-143" href="#__codelineno-8-143"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-144" name="__codelineno-8-144" href="#__codelineno-8-144"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to lookup pcpu ctx&quot;</span><span class="p">);</span>
<a id="__codelineno-8-145" name="__codelineno-8-145" href="#__codelineno-8-145"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-146" name="__codelineno-8-146" href="#__codelineno-8-146"></a><span class="w">    </span><span class="n">bpf_cpumask_set_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">primary</span><span class="p">);</span>
<a id="__codelineno-8-147" name="__codelineno-8-147" href="#__codelineno-8-147"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-8-148" name="__codelineno-8-148" href="#__codelineno-8-148"></a><span class="cm">     * Check to see whether the CPU is in the reserved nest. This can</span>
<a id="__codelineno-8-149" name="__codelineno-8-149" href="#__codelineno-8-149"></a><span class="cm">     * happen if the core is compacted concurrently with us trying to place</span>
<a id="__codelineno-8-150" name="__codelineno-8-150" href="#__codelineno-8-150"></a><span class="cm">     * the currently-waking task onto it. Similarly, this is the expected</span>
<a id="__codelineno-8-151" name="__codelineno-8-151" href="#__codelineno-8-151"></a><span class="cm">     * state of the core if we found the core in the reserve nest and are</span>
<a id="__codelineno-8-152" name="__codelineno-8-152" href="#__codelineno-8-152"></a><span class="cm">     * promoting it.</span>
<a id="__codelineno-8-153" name="__codelineno-8-153" href="#__codelineno-8-153"></a><span class="cm">     *</span>
<a id="__codelineno-8-154" name="__codelineno-8-154" href="#__codelineno-8-154"></a><span class="cm">     * We don&#39;t have to worry about racing with any other waking task here</span>
<a id="__codelineno-8-155" name="__codelineno-8-155" href="#__codelineno-8-155"></a><span class="cm">     * because we&#39;ve atomically reserved the core with (some variant of)</span>
<a id="__codelineno-8-156" name="__codelineno-8-156" href="#__codelineno-8-156"></a><span class="cm">     * scx_bpf_pick_idle_cpu().</span>
<a id="__codelineno-8-157" name="__codelineno-8-157" href="#__codelineno-8-157"></a><span class="cm">     */</span>
<a id="__codelineno-8-158" name="__codelineno-8-158" href="#__codelineno-8-158"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">reserve</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-159" name="__codelineno-8-159" href="#__codelineno-8-159"></a><span class="w">        </span><span class="n">__sync_sub_and_fetch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nr_reserved</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-8-160" name="__codelineno-8-160" href="#__codelineno-8-160"></a><span class="w">        </span><span class="n">bpf_cpumask_clear_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">reserve</span><span class="p">);</span>
<a id="__codelineno-8-161" name="__codelineno-8-161" href="#__codelineno-8-161"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-162" name="__codelineno-8-162" href="#__codelineno-8-162"></a><span class="w">    </span><span class="n">bpf_rcu_read_unlock</span><span class="p">();</span>
<a id="__codelineno-8-163" name="__codelineno-8-163" href="#__codelineno-8-163"></a><span class="w">    </span><span class="n">update_attached</span><span class="p">(</span><span class="n">tctx</span><span class="p">,</span><span class="w"> </span><span class="n">prev_cpu</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<a id="__codelineno-8-164" name="__codelineno-8-164" href="#__codelineno-8-164"></a><span class="w">    </span><span class="n">scx_bpf_dispatch</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">SCX_DSQ_LOCAL</span><span class="p">,</span><span class="w"> </span><span class="n">slice_ns</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-8-165" name="__codelineno-8-165" href="#__codelineno-8-165"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<a id="__codelineno-8-166" name="__codelineno-8-166" href="#__codelineno-8-166"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>nest_select_cpu</code> function is the heart of the <code>scx_nest</code> scheduler. When a task wakes up, this function determines the most suitable CPU core for its execution. The function follows a series of checks to ensure that tasks are placed on high-frequency, idle cores, promoting efficiency and performance.</p>
<p>Initially, it retrieves the task's context from the <code>task_ctx_stor</code> map. It then locks the read-copy-update (RCU) lock to safely access the primary and reserve CPU masks. The scheduler first attempts to place the task on its attached core, ensuring core affinity. If the attached core is not idle, it tries the previous core. Depending on various conditions, including the task's impatience (<code>r_impatient</code>) and the availability of idle cores in the primary and reserve nests, the scheduler decides whether to migrate the task, promote a core to the primary nest, or demote a core to the reserve nest.</p>
<p>Throughout the process, the scheduler updates relevant statistics to provide insights into its operations. The use of RCU locks ensures that the scheduler's decisions are made safely without interfering with other concurrent operations.</p>
<h4 id="nest_enqueue"><code>nest_enqueue</code></h4>
<p>Handles the enqueuing of tasks into the scheduling queue:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_enqueue</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">u64</span><span class="w"> </span><span class="n">enq_flags</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">tctx</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="n">u64</span><span class="w"> </span><span class="n">vtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scx</span><span class="p">.</span><span class="n">dsq_vtime</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="n">tctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_task_storage_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_ctx_stor</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Unable to find task ctx&quot;</span><span class="p">);</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="cm">     * Limit the amount of budget that an idling task can accumulate</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="cm">     * to one slice.</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="cm">     */</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vtime_before</span><span class="p">(</span><span class="n">vtime</span><span class="p">,</span><span class="w"> </span><span class="n">vtime_now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">slice_ns</span><span class="p">))</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">        </span><span class="n">vtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vtime_now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">slice_ns</span><span class="p">;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">    </span><span class="n">scx_bpf_dispatch_vtime</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">FALLBACK_DSQ_ID</span><span class="p">,</span><span class="w"> </span><span class="n">slice_ns</span><span class="p">,</span><span class="w"> </span><span class="n">vtime</span><span class="p">,</span><span class="w"> </span><span class="n">enq_flags</span><span class="p">);</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>nest_enqueue</code> function manages the queuing of tasks, adjusting their virtual time (<code>vtime</code>) to ensure fairness and prevent tasks from accumulating excessive execution budget while idling. If a task's <code>vtime</code> falls below a certain threshold, it's adjusted to maintain balance within the scheduler.</p>
<h4 id="nest_dispatch"><code>nest_dispatch</code></h4>
<p>Manages the dispatching of tasks to CPU cores:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_dispatch</span><span class="p">,</span><span class="w"> </span><span class="n">s32</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pcpu_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">pcpu_ctx</span><span class="p">;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">primary</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">reserve</span><span class="p">;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="n">s32</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">in_primary</span><span class="p">;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="n">primary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primary_cpumask</span><span class="p">;</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reserve_cpumask</span><span class="p">;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">primary</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">reserve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;No primary or reserve cpumask&quot;</span><span class="p">);</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="n">pcpu_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcpu_ctxs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pcpu_ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to lookup pcpu ctx&quot;</span><span class="p">);</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">scx_bpf_consume</span><span class="p">(</span><span class="n">FALLBACK_DSQ_ID</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">        </span><span class="n">in_primary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">primary</span><span class="p">));</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prev</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">scx</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SCX_TASK_QUEUED</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in_primary</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">            </span><span class="n">scx_bpf_dispatch</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">SCX_DSQ_LOCAL</span><span class="p">,</span><span class="w"> </span><span class="n">slice_ns</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="w">        </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">NOT_CONSUMED</span><span class="p">));</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_primary</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">            </span><span class="cm">/*</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="cm">             * Immediately demote a primary core if the previous</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="cm">             * task on it is dying</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="cm">             *</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="cm">             * Note that we elect to not compact the &quot;first&quot; CPU in</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a><span class="cm">             * the mask so as to encourage at least one core to</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="cm">             * remain in the nest. It would be better to check for</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a><span class="cm">             * whether there is only one core remaining in the</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a><span class="cm">             * nest, but BPF doesn&#39;t yet have a kfunc for querying</span>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="cm">             * cpumask weight.</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a><span class="cm">             */</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">prev</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">__state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TASK_DEAD</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a><span class="w">                </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bpf_cpumask_first</span><span class="p">(</span><span class="n">cast_mask</span><span class="p">(</span><span class="n">primary</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a><span class="w">                </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">EAGERLY_COMPACTED</span><span class="p">));</span>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a><span class="w">                </span><span class="n">bpf_cpumask_clear_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">primary</span><span class="p">);</span>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a><span class="w">                </span><span class="n">try_make_core_reserved</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">reserve</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a><span class="w">                </span><span class="n">pcpu_ctx</span><span class="o">-&gt;</span><span class="n">scheduled_compaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a><span class="w">                </span><span class="cm">/*</span>
<a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a><span class="cm">                 * The core isn&#39;t being used anymore. Set a</span>
<a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a><span class="cm">                 * timer to remove the core from the nest in</span>
<a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a><span class="cm">                 * p_remove if it&#39;s still unused by that point.</span>
<a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a><span class="cm">                 */</span>
<a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a><span class="w">                </span><span class="n">bpf_timer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcpu_ctx</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">p_remove_ns</span><span class="p">,</span>
<a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a><span class="w">                               </span><span class="n">BPF_F_TIMER_CPU_PIN</span><span class="p">);</span>
<a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a><span class="w">                </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">SCHEDULED_COMPACTION</span><span class="p">));</span>
<a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a><span class="w">    </span><span class="n">stat_inc</span><span class="p">(</span><span class="n">NEST_STAT</span><span class="p">(</span><span class="n">CONSUMED</span><span class="p">));</span>
<a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>nest_dispatch</code> function is responsible for dispatching tasks to CPU cores. It first checks if there's a task available in the fallback dispatch queue (<code>FALLBACK_DSQ_ID</code>). If no task is consumed, it evaluates whether the previous task on the CPU is dead. If so, and the CPU is not the first in the primary mask, the scheduler demotes the core to the reserve nest. Otherwise, it schedules a compaction timer to potentially demote the core after a specified duration (<code>p_remove_ns</code>). If a task is successfully consumed from the fallback queue, it increments the corresponding statistic.</p>
<h4 id="nest_running"><code>nest_running</code></h4>
<p>Updates the global virtual time when a task starts running:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_running</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="cm">     * Global vtime always progresses forward as tasks start executing. The</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="cm">     * test and update can be performed concurrently from multiple CPUs and</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="cm">     * thus racy. Any error should be contained and temporary. Let&#39;s just</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="cm">     * live with it.</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="cm">     */</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vtime_before</span><span class="p">(</span><span class="n">vtime_now</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scx</span><span class="p">.</span><span class="n">dsq_vtime</span><span class="p">))</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">        </span><span class="n">vtime_now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scx</span><span class="p">.</span><span class="n">dsq_vtime</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>nest_running</code> function ensures that the global virtual time (<code>vtime_now</code>) progresses forward as tasks start executing. This mechanism helps maintain fairness and temporal consistency across the scheduler's operations.</p>
<h4 id="nest_stopping"><code>nest_stopping</code></h4>
<p>Handles the stopping of a task, adjusting its virtual time:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_stopping</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">runnable</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="cm">/* scale the execution time by the inverse of the weight and charge */</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scx</span><span class="p">.</span><span class="n">dsq_vtime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">slice_ns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scx</span><span class="p">.</span><span class="n">slice</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scx</span><span class="p">.</span><span class="n">weight</span><span class="p">;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="p">}</span>
</code></pre></div>
<p>When a task stops running, <code>nest_stopping</code> adjusts its virtual time based on its execution slice and weight. This adjustment ensures that tasks are fairly accounted for in the scheduler's virtual time calculations, maintaining balance and preventing any single task from monopolizing CPU resources.</p>
<h4 id="nest_init_task"><code>nest_init_task</code></h4>
<p>Initializes a new task's context:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">s32</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_init_task</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">                   </span><span class="k">struct</span><span class="w"> </span><span class="nc">scx_init_task_args</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="p">{</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">tctx</span><span class="p">;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpumask</span><span class="p">;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="cm">/*</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="cm">     * @p is new. Let&#39;s ensure that its task_ctx is available. We can sleep</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="cm">     * in this function and the following will automatically use GFP_KERNEL.</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="cm">     */</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="n">tctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_task_storage_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task_ctx_stor</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">                                </span><span class="n">BPF_LOCAL_STORAGE_GET_F_CREATE</span><span class="p">);</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tctx</span><span class="p">)</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="n">cpumask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_cpumask_create</span><span class="p">();</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cpumask</span><span class="p">)</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="n">cpumask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_kptr_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">tmp_mask</span><span class="p">,</span><span class="w"> </span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpumask</span><span class="p">)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">        </span><span class="n">bpf_cpumask_release</span><span class="p">(</span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">    </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">attached_core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">    </span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">prev_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>nest_init_task</code> function initializes the scheduling context for a new task. It ensures that the task's context is available by retrieving it from the <code>task_ctx_stor</code> map, creating a new <code>bpf_cpumask</code> for temporary calculations, and setting initial values for <code>attached_core</code> and <code>prev_cpu</code>.</p>
<h4 id="nest_enable"><code>nest_enable</code></h4>
<p>Enables scheduling for a task by setting its virtual time:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_enable</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scx</span><span class="p">.</span><span class="n">dsq_vtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vtime_now</span><span class="p">;</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>nest_enable</code> function activates scheduling for a task by initializing its virtual time (<code>dsq_vtime</code>) to the current global virtual time (<code>vtime_now</code>). This ensures that the task's scheduling state is synchronized with the scheduler's virtual time.</p>
<h4 id="stats_timerfn"><code>stats_timerfn</code></h4>
<p>Handles periodic statistics collection:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">stats_timerfn</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_timer</span><span class="w"> </span><span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="p">{</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="n">s32</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">primary</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">reserve</span><span class="p">;</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">idle</span><span class="p">;</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="n">stats_primary_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="n">stats_reserved_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="n">stats_other_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="n">stats_idle_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">    </span><span class="n">bpf_rcu_read_lock</span><span class="p">();</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">    </span><span class="n">primary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">primary_cpumask</span><span class="p">;</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">    </span><span class="n">reserve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reserve_cpumask</span><span class="p">;</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">primary</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">reserve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">        </span><span class="n">bpf_rcu_read_unlock</span><span class="p">();</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to lookup primary or reserve&quot;</span><span class="p">);</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="w">    </span><span class="n">idle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scx_bpf_get_idle_cpumask</span><span class="p">();</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="w">    </span><span class="n">bpf_for</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">nr_cpus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">primary</span><span class="p">)))</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="w">            </span><span class="n">stats_primary_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">cast_mask</span><span class="p">(</span><span class="n">reserve</span><span class="p">)))</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="w">            </span><span class="n">stats_reserved_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="w">            </span><span class="n">stats_other_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">idle</span><span class="p">))</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="w">            </span><span class="n">stats_idle_mask</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="w">    </span><span class="n">bpf_rcu_read_unlock</span><span class="p">();</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="w">    </span><span class="n">scx_bpf_put_idle_cpumask</span><span class="p">(</span><span class="n">idle</span><span class="p">);</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_timer_start</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">sampling_cadence_ns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to arm stats timer&quot;</span><span class="p">);</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>stats_timerfn</code> function is invoked periodically by a central timer to collect and update scheduler statistics. It captures the current state of CPU cores, categorizing them into primary, reserve, other, and idle masks. This information provides insights into how the scheduler is managing CPU resources and task placement over time. After collecting the statistics, the function re-arms the timer to ensure continuous monitoring.</p>
<h4 id="nest_init"><code>nest_init</code></h4>
<p>Initializes the <code>scx_nest</code> scheduler:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">s32</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS_SLEEPABLE</span><span class="p">(</span><span class="n">nest_init</span><span class="p">)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_cpumask</span><span class="w"> </span><span class="o">*</span><span class="n">cpumask</span><span class="p">;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">s32</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_timer</span><span class="w"> </span><span class="o">*</span><span class="n">timer</span><span class="p">;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scx_bpf_create_dsq</span><span class="p">(</span><span class="n">FALLBACK_DSQ_ID</span><span class="p">,</span><span class="w"> </span><span class="n">NUMA_NO_NODE</span><span class="p">);</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to create fallback DSQ&quot;</span><span class="p">);</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">    </span><span class="n">cpumask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_cpumask_create</span><span class="p">();</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cpumask</span><span class="p">)</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="w">    </span><span class="n">bpf_cpumask_clear</span><span class="p">(</span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="w">    </span><span class="n">cpumask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_kptr_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">primary_cpumask</span><span class="p">,</span><span class="w"> </span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpumask</span><span class="p">)</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="w">        </span><span class="n">bpf_cpumask_release</span><span class="p">(</span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="w">    </span><span class="n">cpumask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_cpumask_create</span><span class="p">();</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cpumask</span><span class="p">)</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="w">    </span><span class="n">bpf_cpumask_clear</span><span class="p">(</span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="w">    </span><span class="n">cpumask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_kptr_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reserve_cpumask</span><span class="p">,</span><span class="w"> </span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpumask</span><span class="p">)</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="w">        </span><span class="n">bpf_cpumask_release</span><span class="p">(</span><span class="n">cpumask</span><span class="p">);</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="w">    </span><span class="n">bpf_for</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">nr_cpus</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="w">        </span><span class="n">s32</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">pcpu_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcpu_ctxs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="w">            </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to lookup pcpu_ctx&quot;</span><span class="p">);</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a><span class="w">        </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">scheduled_compaction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bpf_timer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pcpu_ctxs</span><span class="p">,</span><span class="w"> </span><span class="n">CLOCK_BOOTTIME</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a><span class="w">            </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to initialize pcpu timer&quot;</span><span class="p">);</span>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a><span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_timer_set_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">compact_primary_core</span><span class="p">);</span>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="w">            </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to set pcpu timer callback&quot;</span><span class="p">);</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a><span class="w">    </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats_timer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">timer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to lookup central timer&quot;</span><span class="p">);</span>
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a><span class="w">    </span><span class="n">bpf_timer_init</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stats_timer</span><span class="p">,</span><span class="w"> </span><span class="n">CLOCK_BOOTTIME</span><span class="p">);</span>
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a><span class="w">    </span><span class="n">bpf_timer_set_callback</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">stats_timerfn</span><span class="p">);</span>
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a><span class="w">    </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_timer_start</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span><span class="w"> </span><span class="n">sampling_cadence_ns</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a><span class="w">        </span><span class="n">scx_bpf_error</span><span class="p">(</span><span class="s">&quot;Failed to arm stats timer&quot;</span><span class="p">);</span>
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>nest_init</code> function sets up the <code>scx_nest</code> scheduler during system initialization. It creates a fallback dispatch queue (<code>FALLBACK_DSQ_ID</code>) and initializes the primary and reserve CPU masks. For each CPU, it retrieves the per-CPU context from the <code>pcpu_ctxs</code> map, initializes a timer for core compaction, and sets the callback to <code>compact_primary_core</code>. Additionally, it initializes and starts the central statistics timer (<code>stats_timer</code>) with the callback function <code>stats_timerfn</code>, ensuring that scheduler statistics are continuously monitored.</p>
<h4 id="nest_exit"><code>nest_exit</code></h4>
<p>Handles cleanup when the scheduler exits:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_exit</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">scx_exit_info</span><span class="w"> </span><span class="o">*</span><span class="n">ei</span><span class="p">)</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="n">UEI_RECORD</span><span class="p">(</span><span class="n">uei</span><span class="p">,</span><span class="w"> </span><span class="n">ei</span><span class="p">);</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="p">}</span>
</code></pre></div>
<p>The <code>nest_exit</code> function records exit information and performs any necessary cleanup when the scheduler is being removed or the system is shutting down. This ensures that all resources are properly released and that the system remains stable.</p>
<h4 id="scx_ops_define"><code>SCX_OPS_DEFINE</code></h4>
<p>Defines the operations structure for the <code>scx_nest</code> scheduler:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">SCX_OPS_DEFINE</span><span class="p">(</span><span class="n">nest_ops</span><span class="p">,</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">               </span><span class="p">.</span><span class="n">select_cpu</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_select_cpu</span><span class="p">,</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">               </span><span class="p">.</span><span class="n">enqueue</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_enqueue</span><span class="p">,</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">               </span><span class="p">.</span><span class="n">dispatch</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_dispatch</span><span class="p">,</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">               </span><span class="p">.</span><span class="n">running</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_running</span><span class="p">,</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">               </span><span class="p">.</span><span class="n">stopping</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_stopping</span><span class="p">,</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">               </span><span class="p">.</span><span class="n">init_task</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_init_task</span><span class="p">,</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">               </span><span class="p">.</span><span class="n">enable</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_enable</span><span class="p">,</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">               </span><span class="p">.</span><span class="n">init</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_init</span><span class="p">,</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">               </span><span class="p">.</span><span class="n">exit</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_exit</span><span class="p">,</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">               </span><span class="p">.</span><span class="n">flags</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">               </span><span class="p">.</span><span class="n">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;nest&quot;</span><span class="p">);</span>
</code></pre></div>
<p>The <code>SCX_OPS_DEFINE</code> macro binds all the scheduler's functions to the <code>nest_ops</code> structure, which the <code>sched_ext</code> framework uses to interface with the scheduler. This structure ensures that the scheduler's operations are correctly mapped and invoked by the kernel during task scheduling events.</p>
<h3 id="initialization-and-cleanup">Initialization and Cleanup</h3>
<p>Proper initialization and cleanup are crucial for the scheduler's stability and performance.</p>
<h4 id="nest_init-function"><code>nest_init</code> Function</h4>
<p>The <code>nest_init</code> function is responsible for setting up the scheduler during system initialization. Here's how it operates:</p>
<ol>
<li><strong>Create Fallback Dispatch Queue:</strong></li>
<li>
<p>It calls <code>scx_bpf_create_dsq</code> to create a fallback dispatch queue (<code>FALLBACK_DSQ_ID</code>). If this fails, it logs an error and exits.</p>
</li>
<li>
<p><strong>Initialize Primary and Reserve CPU Masks:</strong></p>
</li>
<li>It creates and clears a new <code>bpf_cpumask</code> for the primary mask.</li>
<li>It exchanges the newly created mask with the existing <code>primary_cpumask</code>. If an old mask exists, it releases it.</li>
<li>
<p>The same process is repeated for the reserve mask.</p>
</li>
<li>
<p><strong>Initialize Per-CPU Contexts:</strong></p>
</li>
<li>For each CPU, it retrieves the per-CPU context from the <code>pcpu_ctxs</code> map.</li>
<li>It initializes the <code>scheduled_compaction</code> flag to <code>false</code>.</li>
<li>It initializes the timer using <code>bpf_timer_init</code> and sets the callback to <code>compact_primary_core</code> using <code>bpf_timer_set_callback</code>.</li>
<li>
<p>If any of these steps fail, it logs an error and exits.</p>
</li>
<li>
<p><strong>Initialize and Start Statistics Timer:</strong></p>
</li>
<li>It retrieves the central statistics timer from the <code>stats_timer</code> map.</li>
<li>It initializes the timer and sets its callback to <code>stats_timerfn</code>.</li>
<li>It starts the timer with a delay of <code>sampling_cadence_ns - 5000</code> nanoseconds.</li>
<li>
<p>If starting the timer fails, it logs an error.</p>
</li>
<li>
<p><strong>Return:</strong></p>
</li>
<li>The function returns the result of the timer initialization, indicating success or failure.</li>
</ol>
<p>This initialization process ensures that all necessary components of the scheduler are correctly set up, including CPU masks, timers, and dispatch queues.</p>
<h4 id="nest_exit-function"><code>nest_exit</code> Function</h4>
<p>The <code>nest_exit</code> function handles cleanup when the scheduler is being removed or the system is shutting down:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">BPF_STRUCT_OPS</span><span class="p">(</span><span class="n">nest_exit</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">scx_exit_info</span><span class="w"> </span><span class="o">*</span><span class="n">ei</span><span class="p">)</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="p">{</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="n">UEI_RECORD</span><span class="p">(</span><span class="n">uei</span><span class="p">,</span><span class="w"> </span><span class="n">ei</span><span class="p">);</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="p">}</span>
</code></pre></div>
<p>This function records exit information through the <code>UEI_RECORD</code> macro, ensuring that any necessary cleanup actions are performed. Proper cleanup is essential to maintain system stability and prevent resource leaks.</p>
<h3 id="final-scheduler-definition">Final Scheduler Definition</h3>
<p>The <code>SCX_OPS_DEFINE</code> macro binds all the scheduler's functions into a single structure used by the <code>sched_ext</code> framework:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">SCX_OPS_DEFINE</span><span class="p">(</span><span class="n">nest_ops</span><span class="p">,</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">               </span><span class="p">.</span><span class="n">select_cpu</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_select_cpu</span><span class="p">,</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">               </span><span class="p">.</span><span class="n">enqueue</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_enqueue</span><span class="p">,</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">               </span><span class="p">.</span><span class="n">dispatch</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_dispatch</span><span class="p">,</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">               </span><span class="p">.</span><span class="n">running</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_running</span><span class="p">,</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">               </span><span class="p">.</span><span class="n">stopping</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_stopping</span><span class="p">,</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">               </span><span class="p">.</span><span class="n">init_task</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_init_task</span><span class="p">,</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">               </span><span class="p">.</span><span class="n">enable</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_enable</span><span class="p">,</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">               </span><span class="p">.</span><span class="n">init</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_init</span><span class="p">,</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">               </span><span class="p">.</span><span class="n">exit</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">nest_exit</span><span class="p">,</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">               </span><span class="p">.</span><span class="n">flags</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">               </span><span class="p">.</span><span class="n">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;nest&quot;</span><span class="p">);</span>
</code></pre></div>
<p>This structure, <code>nest_ops</code>, effectively registers the scheduler's operations with the <code>sched_ext</code> framework, ensuring that the scheduler responds appropriately to various scheduling events and system states.</p>
<h2 id="compilation-and-execution">Compilation and Execution</h2>
<p>To compile and run the <code>scx_nest</code> scheduler, follow these steps:</p>
<p><strong>Compile the Code:</strong></p>
<p>Use <code>make</code> to build the scheduler. Ensure that you have the necessary build tools and kernel headers installed.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>make
</code></pre></div>
<p><strong>Run the Scheduler:</strong></p>
<p>Execute the compiled scheduler binary. Depending on your system's configuration and permissions, you might need to run this command with elevated privileges.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>./scx_nest
</code></pre></div>
<h3 id="sample-output">Sample Output</h3>
<p>Upon running the scheduler, you should observe output similar to the following:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a># ./scx_nest 
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>Wakeup stats
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>------------
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>WAKEUP_ATTACHED=150
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>WAKEUP_PREV_PRIMARY=61
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>WAKEUP_FULLY_IDLE_PRIMARY=0
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>WAKEUP_ANY_IDLE_PRIMARY=103
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>WAKEUP_FULLY_IDLE_RESERVE=0
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>WAKEUP_ANY_IDLE_RESERVE=216
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>WAKEUP_IDLE_OTHER=11
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>Nest stats
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>----------
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>TASK_IMPATIENT=67
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>PROMOTED_TO_PRIMARY=217
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>PROMOTED_TO_RESERVED=8
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>DEMOTED_TO_RESERVED=212
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>RESERVED_AT_CAPACITY=6
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>SCHEDULED_COMPACTION=525
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>CANCELLED_COMPACTION=314
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>EAGERLY_COMPACTED=8
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>CALLBACK_COMPACTED=208
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>Consume stats
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>-------------
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>CONSUMED=166
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>NOT_CONSUMED=667
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>Masks
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>-----
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>PRIMARY  ( 0): | -------------------------------------------------------------------------------------------------------------------------------- |
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>RESERVED (10): | ***-*--*--------------------------------------------------------***-*--*-------------------------------------------------------- |
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>OTHER    (128): | ******************************************************************************************************************************** |
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>IDLE     (16): | ********--------------------------------------------------------********-------------------------------------------------------- |
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>^CEXIT: unregistered from user space
</code></pre></div>
<p>This output provides comprehensive statistics on task wakeups, nest operations, consumption rates, and CPU mask statuses. It indicates how the scheduler is managing tasks and CPU cores, showcasing the effectiveness of the <code>scx_nest</code> algorithm in maintaining high-frequency core utilization and efficient task placement.</p>
<h2 id="summary-and-call-to-action">Summary and Call to Action</h2>
<p>In this tutorial, we've delved into the implementation of the <code>scx_nest</code> scheduler, an advanced eBPF program that customizes CPU scheduling to optimize performance based on core frequency and utilization. By leveraging the <code>sched_ext</code> framework, <code>scx_nest</code> demonstrates how eBPF can dynamically define scheduling behavior, offering flexibility and control beyond traditional schedulers.</p>
<p>Key takeaways include:</p>
<ul>
<li>Understanding the flexibility and power of the <code>sched_ext</code> scheduler class.</li>
<li>Exploring the intricate data structures and maps that underpin the <code>scx_nest</code> scheduler.</li>
<li>Analyzing core functions that manage task placement, core compaction, and statistics collection.</li>
<li>Learning how to compile and execute the scheduler, observing its impact through detailed statistics.</li>
</ul>
<p>The <code>scx_nest</code> scheduler serves as an excellent example of how advanced eBPF programming can be utilized to implement complex system functionalities in a flexible and dynamic manner.</p>
<p>If you'd like to dive deeper into eBPF and explore more advanced examples, visit our tutorial repository at <a href="https://github.com/eunomia-bpf/bpf-developer-tutorial">https://github.com/eunomia-bpf/bpf-developer-tutorial</a> or check out our website at <a href="https://eunomia.dev/tutorials/">https://eunomia.dev/tutorials/</a>.</p>
<h2 id="references">References</h2>
<p>The original source code for the <code>scx_nest</code> scheduler is available in the <a href="https://github.com/sched-ext/scx">sched-ext/scx</a> repository.</p>
<p>Additional resources that can enhance your understanding include:</p>
<ul>
<li><strong>Linux Kernel Documentation:</strong> <a href="https://www.kernel.org/doc/html/next/scheduler/sched-ext.html">Scheduler Ext Documentation</a></li>
<li><strong>Kernel Source Tree:</strong> <a href="https://github.com/torvalds/linux/tree/master/tools/sched_ext">Linux Kernel <code>sched_ext</code> Tools</a></li>
<li><strong>eBPF Official Documentation:</strong> <a href="https://ebpf.io/docs/">https://ebpf.io/docs/</a></li>
<li><strong>libbpf Documentation:</strong> <a href="https://github.com/libbpf/libbpf">https://github.com/libbpf/libbpf</a></li>
</ul>
<p>Feel free to explore these resources to expand your knowledge and continue your journey into advanced eBPF programming!</p>
<p><a class="md-button" href="https://x.com/intent/tweet?text=eBPF%20Tutorial%20by%20Example%3A%20Implementing%20the%20%60scx_nest%60%20Scheduler%0A&amp;url=https://eunomia.dev/tutorials/45-scx-nest/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg></span></a>
<a class="md-button" href="https://www.facebook.com/sharer/sharer.php?u=https://eunomia.dev/tutorials/45-scx-nest/">Share on <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401 0 .955.042 1.468.103a9 9 0 0 1 1.141.195v3.325a9 9 0 0 0-.653-.036 27 27 0 0 0-.733-.009c-.707 0-1.259.096-1.675.309a1.7 1.7 0 0 0-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647"/></svg></span></a></p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 10, 2025</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 10, 2025</span>
  </span>

    
    
      
  
  <span class="md-source-file__fact">
    <span class="md-icon" title="Contributors">
      
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg>
      
    </span>
    <nav>
      
        <a href="mailto:1067852565@qq.com">云微</a>
    </nav>
  </span>

    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="https://github.com/orgs/eunomia-bpf/discussions" target="_blank" rel="noopener">Github discussion</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


<script src="https://giscus.app/client.js"
        data-repo="eunomia-bpf/bpf-developer-tutorial"
        data-repo-id="R_kgDOIi0KhQ"
        data-category="General"
        data-category-id="DIC_kwDOIi0Khc4CYq-h"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../44-scx-simple/" class="md-footer__link md-footer__link--prev" aria-label="Previous: eBPF Tutorial: Introduction to the BPF Scheduler">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                eBPF Tutorial: Introduction to the BPF Scheduler
              </div>
            </div>
          </a>
        
        
          
          <a href="../46-xdp-test/" class="md-footer__link md-footer__link--next" aria-label="Next: xdp-pktgen: xdp based packet generator">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                xdp-pktgen: xdp based packet generator
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright (c) 2024 eunomia-bpf org.
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/eunomia-bpf" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:yunwei356@gmail.com" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.footer", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.expand", "navigation.path", "navigation.top", "content.tabs.link", "content.action.edit", "content.action.view"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
<script src="https://cdn.usefathom.com/script.js" data-site="ZLDAHRNN" defer></script>

      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
    

  </body>
</html>